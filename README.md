> [!WARNING]
> **AI Generation Disclaimer**

> This project, including this very README, was largely generated by Large Language Models (LLMs). It is a Go rewrite of a previous, "organically" written Python version. I originally intended to port the code myself, but I was seduced by the dark side of lazyness: the LLMs were simply much faster than my own two hands (and brain). I think I'll write a LinkedIn article about this experience because I definitely master Golang now.

# Twitch Chat Scraper (Poglytics)

A high-performance, scalable Twitch chat scraper written in Go that monitors multiple channels simultaneously using connection pooling and stores chat data in various databases with comprehensive monitoring capabilities.

## Features

- **Connection Pooling**: Efficiently manages multiple IRC connections to monitor thousands of channels
- **Multi-Database Support**: Store chat data in ClickHouse, PostgreSQL, or SQLite
- **Comprehensive Event Tracking**: Captures messages, subscriptions, bans, timeouts, raids, cheers, and more
- **Prometheus Metrics**: Built-in monitoring with detailed metrics on connections, messages, and performance
- **Grafana Dashboards**: Pre-configured monitoring dashboards for visualization
- **Docker Support**: Easy deployment with Docker Compose
- **Graceful Shutdown**: Proper cleanup and reconnection handling

## Architecture

The scraper uses a connection pool architecture where multiple IRC connections are managed to distribute channel monitoring load. Each connection can handle up to 2000 channels (configurable), allowing the system to scale to monitor tens of thousands of channels simultaneously.

### Components

- **Connection Pool**: Manages IRC connections and channel distribution
- **Subscriber**: Individual IRC connection handler with message parsing
- **Database Layer**: Abstracted database interface supporting multiple backends
- **Metrics**: Prometheus-compatible metrics collection
- **Monitoring Stack**: Grafana + Prometheus for visualization and alerting

## Quick Start

### Prerequisites

- Go 1.24+
- Docker and Docker Compose (for full monitoring stack)

### Environment Setup

1. Copy the environment template:

   ```bash
   cp .env.example .env
   ```

2. Configure your environment variables in `.env`:

   ```env
   CLIENT_ID=your_twitch_client_id
   CLIENT_SECRET=your_twitch_client_secret
   MAX_CHANNELS=50000
   CHANNELS_PER_CONNECTION=2000
   METRICS_PORT=9091
   ```

### Running with Docker

1. Start the database:

   ```bash
   docker-compose up -d clickhouse
   ```

2. Build and run the scraper:

   ```bash
   ./scripts/build.sh
   ./build/twitch-chat-scrapper
   ```

### Running the Monitoring Stack

```bash
cd monitoring
docker-compose up -d
```

Access:

- **Grafana**: <http://localhost:3333> (admin/admin)
- **Prometheus**: <http://localhost:9090>
- **Metrics Endpoint**: <http://localhost:9091/metrics>

## Configuration

### Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `CLIENT_ID` | - | Twitch API Client ID |
| `CLIENT_SECRET` | - | Twitch API Client Secret |
| `MAX_CHANNELS` | 50000 | Maximum channels to monitor |
| `CHANNELS_PER_CONNECTION` | 2000 | Channels per IRC connection |
| `METRICS_PORT` | 9091 | Port for Prometheus metrics |

### Database Configuration

The scraper supports multiple database backends. Configure your choice in the database initialization code.

## Supported Events

The scraper captures and stores the following Twitch chat events:

- **Messages**: Regular chat messages with user metadata
- **Subscriptions**: Sub, resub, and gift sub events
- **Bans/Timeouts**: User moderation actions
- **Deleted Messages**: Message deletion events
- **Raids**: Channel raid notifications
- **Cheers**: Bits/cheer events
- **Notices**: System and moderator notices
- **Other Events**: Custom and miscellaneous events

## Database Schema

### ClickHouse (Recommended for High Volume)

The ClickHouse schema is optimized for analytical queries on large datasets:

```sql
CREATE TABLE chat_messages (
    timestamp DateTime,
    channel String,
    nickname String,
    message String,
    message_type String,
    user_id String,
    display_name String,
    color String,
    badges Array(String),
    -- Additional fields for specific event types
) ENGINE = MergeTree()
ORDER BY (timestamp, channel)
```

### PostgreSQL/SQLite

Relational schema with proper indexing for operational queries.

## Metrics

The scraper exposes comprehensive Prometheus metrics:

### Message Metrics

- `twitch_scraper_messages_total`: Total messages received
- `twitch_scraper_messages_per_second`: Current message rate
- `twitch_scraper_messages_per_connection_total`: Messages per connection

### Connection Metrics

- `twitch_scraper_active_connections`: Number of active connections
- `twitch_scraper_joined_channels_total`: Total joined channels
- `twitch_scraper_channel_join_attempts_total`: Join attempt statistics

### Performance Metrics

- Connection health and reconnection counts
- Database operation timings
- Memory and CPU usage indicators

## Development

### Building

```bash
./scripts/build.sh
```

This creates binaries in the `build/` directory:

- `twitch-chat-scrapper`: Main scraper application
- `analytics`: Data analysis tools
- `query-db`: Database query utilities

### Testing

```bash
go test ./...
```

### Code Structure

```
cmd/
├── twitch-chat-scrapper/    # Main application entry point
internal/
├── app/                     # Core application logic
│   ├── connection.go       # IRC connection handling
│   ├── pool.go            # Connection pool management
│   ├── subscriber.go      # Individual subscriber logic
│   └── types.go           # Core data structures
├── config/                 # Configuration management
├── db/                     # Database abstractions
│   ├── clickhouse.go      # ClickHouse implementation
│   ├── postgres.go        # PostgreSQL implementation
│   ├── sqlite.go          # SQLite implementation
│   └── interface.go       # Database interface
├── metrics/                # Prometheus metrics
├── twitch/                 # Twitch API client
└── util/                   # Utility functions
```

## Monitoring

### Grafana Dashboard

Import the dashboard from `monitoring/grafana/dashboard.json` to visualize:

- Message throughput over time
- Connection health and status
- Channel join success rates
- Database performance metrics
- System resource usage

### Alerts

Configure Prometheus alerts for:
- Connection failures
- High message drop rates
- Database connectivity issues
- System resource thresholds

## Performance Considerations

### Scaling

- **Connections**: Each IRC connection can handle ~2000 channels
- **Database**: ClickHouse recommended for >100k messages/minute
- **Memory**: ~50MB per 2000 channels + database connection overhead
- **Network**: ~10-50Mbps depending on message volume

### Optimization Tips

1. Use ClickHouse for high-volume deployments
2. Monitor connection limits (Twitch IRC has rate limits)
3. Implement proper backoff for reconnections
4. Use SSD storage for database performance
5. Configure appropriate ulimits for file descriptors

## Troubleshooting

### Common Issues

1. **Connection Failures**: Check network connectivity and Twitch service status
2. **High Memory Usage**: Reduce channels per connection or increase system memory
3. **Database Performance**: Ensure proper indexing and consider partitioning
4. **Metrics Not Appearing**: Verify Prometheus configuration and network access

### Logs

Check the following log files in the `logs/` directory:
- `messages.log`: All chat messages
- `bans.log`: Ban and timeout events
- `subscriptions.log`: Subscription events
- `disconnections.log`: Connection status changes

### Debug Mode

Set environment variable `DEBUG=1` for verbose logging.

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes with tests
4. Ensure metrics and monitoring work correctly
5. Submit a pull request
